name: E2E Tests

on:
  pull_request:
    branches: ['*']
  push:
    branches: [main]

# Shared environment variables for all jobs.
# DATABASE_PATH uses the default library.db path so that the Electron
# test fixture (which hardcodes data/library.db) reads from the same
# database the setup steps populate.
# NEXTAUTH_SECRET is required by NextAuth.js at runtime; any stable
# value works for testing.
env:
  DATABASE_PATH: ./data/library.db
  NEXTAUTH_SECRET: e2e-test-secret-do-not-use-in-production

jobs:
  build-watcher:
    name: build-watcher
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
      - uses: Swatinem/rust-cache@v2
        with:
          workspaces: watcher-rs -> target
      - run: |
          sudo apt-get update
          sudo apt-get install -y build-essential
      - run: cargo build --manifest-path watcher-rs/Cargo.toml --release --locked
      - uses: actions/upload-artifact@v4
        with:
          name: watcher-rs-binary
          path: watcher-rs/target/release/watcher-rs
          retention-days: 1

  e2e-web:
    name: e2e-web
    needs: build-watcher
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - run: corepack enable
      - uses: actions/setup-node@v4
        with: { node-version: 20, cache: pnpm }
      - run: pnpm install --frozen-lockfile
      - name: Get Playwright version
        id: pw-version
        run: echo "version=$(pnpm exec playwright --version)" >> "$GITHUB_OUTPUT"
      - uses: actions/cache@v4
        id: playwright-cache
        with:
          path: ~/.cache/ms-playwright
          key: playwright-${{ runner.os }}-${{ steps.pw-version.outputs.version }}
      - run: pnpm exec playwright install --with-deps chromium
        if: steps.playwright-cache.outputs.cache-hit != 'true'
      - run: pnpm exec playwright install-deps chromium
        if: steps.playwright-cache.outputs.cache-hit == 'true'
      - uses: actions/download-artifact@v4
        with:
          name: watcher-rs-binary
          path: watcher-rs/target/release
      - run: chmod +x watcher-rs/target/release/watcher-rs
      - run: mkdir -p data && pnpm db:push && pnpm db:seed
      - run: pnpm build
      - run: pnpm exec playwright test --config=e2e/playwright.config.ts
        env:
          E2E_PLATFORM: web
      - uses: actions/upload-artifact@v4
        if: failure()
        with:
          name: e2e-web-report
          path: playwright-report/

  e2e-electron:
    name: e2e-electron
    needs: build-watcher
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - run: corepack enable
      - uses: actions/setup-node@v4
        with: { node-version: 20, cache: pnpm }
      - run: pnpm install --frozen-lockfile
      - name: Get Playwright version
        id: pw-version
        run: echo "version=$(pnpm exec playwright --version)" >> "$GITHUB_OUTPUT"
      # Playwright needs chromium even for Electron tests because the
      # default browser context is chromium-backed.
      - uses: actions/cache@v4
        id: playwright-cache
        with:
          path: ~/.cache/ms-playwright
          key: playwright-${{ runner.os }}-${{ steps.pw-version.outputs.version }}
      - run: pnpm exec playwright install --with-deps chromium
        if: steps.playwright-cache.outputs.cache-hit != 'true'
      - run: pnpm exec playwright install-deps chromium
        if: steps.playwright-cache.outputs.cache-hit == 'true'
      - uses: actions/download-artifact@v4
        with:
          name: watcher-rs-binary
          path: watcher-rs/target/release
      - run: chmod +x watcher-rs/target/release/watcher-rs
      # Build Next.js with ALEX_DESKTOP=true so the client bundle knows
      # it is running in desktop mode (NEXT_PUBLIC_ALEX_DESKTOP).
      - run: pnpm build
        env:
          ALEX_DESKTOP: 'true'
      # The standalone output requires static assets and public files to
      # be copied alongside the server entry point.
      - run: |
          cp -r .next/static .next/standalone/.next/static
          cp -r public .next/standalone/public
      - run: npx tsc -p electron/tsconfig.json
      - run: mkdir -p data && pnpm db:push && pnpm db:seed
      # Only run specs that test Electron-specific behaviour.  Web-UI
      # tests (library, epub-reader, pdf-reader, collections, progress)
      # are already fully covered by the e2e-web job above.
      #
      # xvfb-run provides a virtual framebuffer on Linux.
      # dbus-run-session provides a valid D-Bus session bus for Chromium.
      - run: >-
          env -u DBUS_SESSION_BUS_ADDRESS
          dbus-run-session --
          xvfb-run --auto-servernum
          pnpm exec playwright test --config=e2e/playwright.config.ts
          e2e/specs/smoke.spec.ts
          e2e/specs/desktop.spec.ts
          e2e/specs/admin.spec.ts
        env:
          E2E_PLATFORM: electron
      - uses: actions/upload-artifact@v4
        if: failure()
        with:
          name: e2e-electron-report
          path: playwright-report/
