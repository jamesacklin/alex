name: E2E Tests

on:
  pull_request:
    branches: ['*']
  push:
    branches: [main]

# Shared environment variables for all jobs.
# DATABASE_PATH uses the default library.db path so that the Electron
# test fixture (which hardcodes data/library.db) reads from the same
# database the setup steps populate.
# NEXTAUTH_SECRET is required by NextAuth.js at runtime; any stable
# value works for testing.
env:
  DATABASE_PATH: ./data/library.db
  NEXTAUTH_SECRET: e2e-test-secret-do-not-use-in-production

jobs:
  e2e-web:
    name: e2e-web
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - run: corepack enable
      - uses: actions/setup-node@v4
        with: { node-version: 20, cache: pnpm }
      - run: pnpm install --frozen-lockfile
      - run: pnpm exec playwright install --with-deps chromium
      - run: |
          sudo apt-get update
          sudo apt-get install -y build-essential
      - run: pnpm build:native
      - run: mkdir -p data && pnpm db:push && pnpm db:seed
      - run: pnpm exec playwright test --config=e2e/playwright.config.ts
        env:
          E2E_PLATFORM: web
      - uses: actions/upload-artifact@v4
        if: failure()
        with:
          name: e2e-web-report
          path: playwright-report/

  e2e-electron-linux:
    name: e2e-electron-linux
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - run: corepack enable
      - uses: actions/setup-node@v4
        with: { node-version: 20, cache: pnpm }
      - run: pnpm install --frozen-lockfile
      # Playwright needs chromium even for Electron tests because the
      # default browser context is chromium-backed.
      - run: pnpm exec playwright install --with-deps chromium
      - run: |
          sudo apt-get update
          sudo apt-get install -y build-essential
      - run: pnpm build:native
      - run: pnpm build
      - run: npx tsc -p electron/tsconfig.json
      - run: mkdir -p data && pnpm db:push && pnpm db:seed
      # xvfb-run provides a virtual framebuffer on Linux, which has no
      # display server. Electron requires a display to launch windows.
      # dbus-run-session provides a valid D-Bus session bus so Electron/Chromium
      # does not emit repeated bus connection errors under CI.
      - run: env -u DBUS_SESSION_BUS_ADDRESS dbus-run-session -- xvfb-run --auto-servernum pnpm exec playwright test --config=e2e/playwright.config.ts
        env:
          E2E_PLATFORM: electron
      - uses: actions/upload-artifact@v4
        if: failure()
        with:
          name: e2e-linux-report
          path: playwright-report/

  e2e-electron-macos:
    name: e2e-electron-macos
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v4
      - run: corepack enable
      - uses: actions/setup-node@v4
        with: { node-version: 20, cache: pnpm }
      - run: pnpm install --frozen-lockfile
      # Playwright needs chromium even for Electron tests.
      - run: pnpm exec playwright install --with-deps chromium
      # macOS has a native display server (Aqua), so no xvfb-run needed.
      - run: pnpm build:native
      - run: pnpm build
      - run: npx tsc -p electron/tsconfig.json
      - run: mkdir -p data && pnpm db:push && pnpm db:seed
      - run: pnpm exec playwright test --config=e2e/playwright.config.ts
        env:
          E2E_PLATFORM: electron
      - uses: actions/upload-artifact@v4
        if: failure()
        with:
          name: e2e-macos-report
          path: playwright-report/
